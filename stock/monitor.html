<!DOCTYPE html>
<html>
<body>
<div id='root'></div>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/javascript">
const Exchange = {
  NYSE: 107,
  NYSE_SAP: 106,
  NASDAQ: 105,
  SH: 1,
  SZ: 0,
  HK: 116,
  CFFEX_DELAY: 220,
  DCE: 114,
  CZCE: 115,
  GFEX: 225,
};

const target = [
  {
    exchange: Exchange.SH,
    code: '512580',
    buy: 1.071,
    sell: 1.673
  },
  {
    exchange: Exchange.SH,
    code: '513300',
    buy: 1.884,
    sell: 2.944
  },
  {
    exchange: Exchange.SH,
    code: '513030',
    buy: 1.548,
    sell: 2.419
  },
  {
    exchange: Exchange.SZ,
    code: '161127',
    buy: 1.427,
    sell: 2.230
  },
  {
    exchange: Exchange.SH,
    code: '512980',
    buy: 0.785,
    sell: 1.226
  },
  {
    exchange: Exchange.SZ,
    code: '159949',
    buy: 1.260,
    sell: 1.968
  },
  {
    exchange: Exchange.SZ,
    code: '162415',
    buy: 2.478,
    sell: 3.871
  },
  {
    exchange: Exchange.SZ,
    code: '159847',
    buy: 0.353,
    sell: 0.551
  },
  {
    exchange: Exchange.SZ,
    code: '159920',
    buy: 1.280,
    sell: 2.000
  },
  {
    exchange: Exchange.SH,
    code: '513500',
    buy: 1.946,
    sell: 3.040
  },
  {
    exchange: Exchange.SZ,
    code: '159938',
    buy: 0.551,
    sell: 0.861
  },
  {
    exchange: Exchange.SH,
    code: '513290',
    buy: 1.292,
    sell: 2.018
  },
  {
    exchange: Exchange.SZ,
    code: '159939',
    buy: 0.707,
    sell: 1.105
  },
  {
    exchange: Exchange.SH,
    code: '513080',
  },
  {
    exchange: Exchange.SH,
    code: '513050',
    buy: 1.201,
    sell: 1.877
  },
  {
    exchange: Exchange.SZ,
    code: '159928',
    buy: 0.654,
    sell: 1.023
  },
  {
    exchange: Exchange.SH,
    code: '512660',
    buy: 1.062,
    sell: 1.660
  },
];

const grid = [
  {
    exchange: Exchange.SZ,
    code: '159920',
    buy: 1.38,
    sell: null
  },
  {
    exchange: Exchange.SH,
    code: '515180',
    buy: 1.18,
    sell: null
  },
  {
    exchange: Exchange.SZ,
    code: '159922',
    buy: 2.355,
    sell: null
  },
  {
    exchange: Exchange.SZ,
    code: '159949',
    buy: 0.975,
    sell: null
  },
  {
    exchange: Exchange.SH,
    code: '513030',
    buy: 1.04,
    sell: null
  },
  {
    exchange: Exchange.SZ,
    code: '159938',
    buy: null,
    sell: 0.78
  },
  {
    exchange: Exchange.SH,
    code: '513050',
    buy: 1.35,
    sell: 1.53
  },
  {
    exchange: Exchange.SH,
    code: '513330',
    buy: 0.492,
    sell: 0.574
  },
  {
    exchange: Exchange.SH,
    code: '512580',
    buy: 0.92,
    sell: null
  },
  {
    exchange: Exchange.SH,
    code: '512980',
    buy: 0.72,
    sell: null
  },
  {
    exchange: Exchange.SZ,
    code: '159939',
    buy: 0.585,
    sell: null
  },
  {
    exchange: Exchange.SH,
    code: '515560',
    buy: 0.958,
    sell: null
  },
  {
    exchange: Exchange.SH,
    code: '512400',
    buy: 0.72,
  },
  {
    exchange: Exchange.SZ,
    code: '159518',
    buy: 0.488,
  },
];

const blackCar = [
  {
    exchange: Exchange.SH,
    code: '600529',
    sell: 22.46,
  },
  {
    exchange: Exchange.SH,
    code: '518880',
    buy: 3.54,
  },
  {
    exchange: Exchange.SZ,
    code: '159518',
    buy: 0.5,
  },
  {
    exchange: Exchange.SZ,
    code: '159866',
    buy: 0.751,
  },
  {
    exchange: Exchange.SH,
    code: '113052',
    sell: 130,
  },
  {
    exchange: Exchange.SH,
    code: '118032',
    sell: 130,
  },
  {
    exchange: Exchange.SZ,
    code: '127056',
    sell: 130,
  },
  {
    exchange: Exchange.HK,
    code: '00700',
    sell: 700,
  },
  {
    exchange: Exchange.HK,
    code: '00941',
    sell: 88.9,
  },
  {
    exchange: Exchange.NYSE_SAP,
    code: 'SAP',
    sell: 311,
  },
  {
    exchange: Exchange.CFFEX_DELAY,
    code: 'TLM',
    buy: 114,
    sell: 118,
  },
  {
    exchange: Exchange.GFEX,
    code: 'psm',
    buy: 45000,
    sell: 55000,
  },
  {
    exchange: Exchange.CZCE,
    code: 'SAM',
    buy: 1100,
    sell: 1500,
  },
  {
    exchange: Exchange.CZCE,
    code: 'FGM',
    buy: 1000,
    sell: 1400,
  },
  {
    exchange: Exchange.DCE,
    code: 'mm',
    buy: 2800,
  },
];

const rebalance = [
  {
    exchange: Exchange.NYSE,
    code: 'SPYM',
    price: 80.53,
    percentage: 15
  },
  {
    exchange: Exchange.NASDAQ,
    code: 'QQQM',
    price: 253.97,
    percentage: 15
  },
  {
    exchange: Exchange.NYSE,
    code: 'VYM',
    price: 143.9,
    percentage: 10
  },
  {
    exchange: Exchange.NYSE,
    code: 'ASHR',
    price: 32.835,
    percentage: 7
  },
  {
    exchange: Exchange.NASDAQ,
    code: 'MCHI',
    price: 60,
    percentage: 7
  },
  {
    exchange: Exchange.NYSE,
    code: 'EEM',
    price: 54.705,
    percentage: 6
  },
  {
    exchange: Exchange.NYSE,
    code: 'EWG',
    price: 42.53,
    percentage: 5
  },
  {
    exchange: Exchange.NYSE,
    code: 'EWQ',
    price: 44.98,
    percentage: 5
  },
  {
    exchange: Exchange.NYSE,
    code: 'EWU',
    price: 44.015,
    percentage: 5
  },
  {
    exchange: Exchange.NYSE,
    code: 'EWJ',
    price: 80.588,
    percentage: 5
  },
  {
    exchange: Exchange.NYSE,
    code: 'GLDM',
    price: 85.86,
    percentage: 15
  },
  {
    exchange: Exchange.NYSE,
    code: 'XOP',
    price: 125.67,
    percentage: 5
  },
];

const codeToPricePromise = {};

const fetchPrice = async (stockCode, exchange, startDate, endDate) => {
  if (codeToPricePromise[stockCode] === undefined) {
    // codeToPricePromise[stockCode] = fetchPriceEastMoney(stockCode, exchange, startDate, endDate);
    codeToPricePromise[stockCode] = fetchPriceEastMoneyCritical(stockCode, exchange, startDate, endDate);
  }
  const pricePromise = codeToPricePromise[stockCode];
  const responseEastMoney = await pricePromise;

  const lastDayPricesString = responseEastMoney.data.klines.at(-1);
  const [dateString, open, closeString, max, min] = lastDayPricesString.split(',');
  return {
    name: responseEastMoney.data.name,
    decimal: responseEastMoney.data.decimal,
    dateString,
    close: parseFloat(closeString),
  }
};

const fetchPriceEastMoney = async (stockCode, exchange, startDate, endDate) => {
  const secid = `${exchange}.${stockCode}`;
  const begin = startDate.toISOString().substring(0, 10).replace(/-/g, '');
  const end = endDate.toISOString().substring(0, 10).replace(/-/g, '');
  const url = `https://push2his.eastmoney.com` +
    `/api/qt/stock/kline/get` +
    `?secid=${secid}` +
    `&fields1=f1%2Cf2%2Cf3%2Cf4%2Cf5%2Cf6` +
    `&fields2=f51%2Cf52%2Cf53%2Cf54%2Cf55` +
    `&klt=101&fqt=0&` +
    `beg=${begin}&end=20500101` +
    `&smplmt=460&lmt=1000000&_=${Date.now()}`;
  const response = await fetch(url); 
  const responseJson = await response.json()
  return responseJson;
};

class Lock {
  constructor() {
    this._locked = false;
    this._queue = [];
  }

  async acquire() {
    if (this._locked) {
      await new Promise(resolve => this._queue.push(resolve));
    }
    this._locked = true;
  }

  release() {
    this._locked = false;
    if (this._queue.length > 0) {
      const next = this._queue.shift();
      next();
    }
  }
}

const lock = new Lock();

const fetchPriceEastMoneyCritical = async (stockCode, exchange, startDate, endDate) => {
  await lock.acquire();
  try {
    console.log('entered', stockCode, exchange, startDate, endDate);
    const result = await fetchPriceEastMoney(stockCode, exchange, startDate, endDate);
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    await sleep(1500);
    console.log('leaving', stockCode, exchange, startDate, endDate);
    return result;
  } finally {
    lock.release();
  }
};


  const fetchSinaFinance = async (stockCode, startDate, endDate) => {
    'https://money.finance.sina.com.cn/quotes_service/api/json_v2.php/CN_MarketData.getKLineData?symbol=sh510300&scale=240&ma=5&datalen=2';
    'https://hq.sinajs.cn/list=sh600519';// Referer: https://finance.sina.com.cn/
  };
  const fetchSinaFuture = async (code, startDate, endDate) => {
    'https://stock2.finance.sina.com.cn/futures/api/json.php/CffexFuturesService.getCffexFuturesDailyKLine?symbol=IC2406';
  };
</script>

<script type="text/babel">
  const { useEffect, useState } = React;
  
  const App = () => {
    const [sh000001, setSh000001] = useState(null);
    
    useEffect(() => {
      (async()=>{
        const endDate = new Date();
        const startDate = new Date(+endDate - 3600*24*1000 * 10);
        const sh000001Price = await fetchPrice('000001', Exchange.SH, startDate, endDate);
        setSh000001(sh000001Price);
      })();
    }, [])

    if (sh000001 === null) {
      return <div>Loading</div>;
    }

    return (
      <div>
        <div>Date: {sh000001.dateString}</div>
        {Section('Target', target, sh000001)}
        {Section('Grid', grid, sh000001)}
        {Section('BlackCar', blackCar, sh000001)}
        <RebalanceTable rebalanceArray={rebalance}/>
      </div>
    );
  }


const Section = (name, monitors, sh000001Price) => {
  return (
    <div>
      <span>{name}</span>
      <table>
        <thead>
          <tr>
            <th>code</th>
            <th>name</th>
            <th>buy</th>
            <th>sell</th>
            <th>price</th>
            <th>percentToBuy</th>
            <th>percentToSell</th>
          </tr>
        </thead>
        <tbody>
          {
            monitors.map((stock, i) => {
              return (
                <TableRow
                  key={i}
                  stock={stock}
                  sh000001Price={sh000001Price}
                />
              )
            })
          }
        </tbody>
      </table>
    </div>
  );
};

const TableRow = ({stock, sh000001Price}) => {
  const [price, setPrice] = useState(0);
  const [name, setName] = useState('');

  useEffect(() => {
    (async (stock)=> {
      const endDate = new Date(sh000001Price.dateString);
      const startDate = new Date(+endDate - 3600*24*1000 * 3);
      const price = await fetchPrice(stock.code, stock.exchange, startDate, endDate);
      setPrice(price.close)
      setName(price.name)
    })(stock);
  }, []);

  const percentToBuy = (stock.buy - price) / price * 100;
  const percentToSell = (stock.sell - price) / price * 100;
  const buyWarn = stock.buy && percentToBuy > -2;
  const buyTriggered = stock.buy && percentToBuy >= 0;
  const sellWarn = stock.sell && percentToSell < 2;
  const sellTriggered = stock.sell && percentToSell <= 0;
  return (
    <tr>
      <td>{stock.code}</td>
      <td>{name}</td>
      <td style={{
        ...(buyTriggered ? {backgroundColor: '#7f7'} : buyWarn && { backgroundColor: '#ff7' }),
      }}>{stock.buy}</td>
      <td style={{
        ...(sellTriggered ? {backgroundColor: '#7f7'} : sellWarn && { backgroundColor: '#ff7' }),
      }}>{stock.sell}</td>
      <td>{price}</td>
      <td style={{
        textAlign: 'right',
        ...(buyTriggered ? {backgroundColor: '#7f7'} : buyWarn && { backgroundColor: '#ff7' }),
      }}>{stock.buy && `${percentToBuy.toFixed(1)}%`}</td>
      <td style={{
        textAlign: 'right',
        ...(sellTriggered ? {backgroundColor: '#7f7'} : sellWarn && { backgroundColor: '#ff7' }),
      }}>{stock.sell && `${percentToSell.toFixed(1)}%`}</td>
    </tr>
  );
}

const RebalanceTable = ({rebalanceArray}) => {
  const [hidden, setHidden] = useState(true);
  const [codeToPrice, setCodeToPrice] = useState({});

  useEffect(() => {
    if (hidden) {
      return;
    }
    for (const stock of rebalanceArray) {
      (async (stock)=> {
        const endDate = new Date();
        const startDate = new Date(+endDate - 3600*24*1000 * 5);
        const price = await fetchPrice(stock.code, stock.exchange, startDate, endDate);
        setCodeToPrice((old) => ({
          ...old,
          [stock.code]: price
        }));
      })(stock);
    }
  }, [hidden]);

  if (hidden) {
    const showRebalanceTable = () => {
      setHidden(false);
      setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    };
    return (
      <>
        <span>Rebalance</span>
        <button onClick={showRebalanceTable}>show</button>
      </>
    );
  }

  const netValue = rebalanceArray.map(rebalanceItem => {
    const quantity = rebalanceItem.percentage / rebalanceItem.price;
    const itemValue = codeToPrice[rebalanceItem.code]?.close * quantity;
    return itemValue;
  }).reduce((a, b) => a + b);

  return (
    <div>
      <span>Rebalance</span>
      <table>
        <thead>
          <tr>
            <th>code</th>
            <th>name</th>
            <th>lastPrice</th>
            <th>price</th>
            <th>percentage</th>
            <th>proportion</th>
            <th>deviation (-25%/+33%)</th>
          </tr>
        </thead>
        <tbody>
          {rebalanceArray.map((rebalanceItem, index) => {
            const closePrice = codeToPrice[rebalanceItem.code]?.close;
            const quantity = rebalanceItem.percentage / rebalanceItem.price;
            const proportion = closePrice * quantity / netValue;
            const deviation = proportion / (rebalanceItem.percentage / 100) - 1;
            const rebalanceTriggered = deviation > 0.33 || deviation < -0.25;
            const rebalanceWarn = deviation > 0.25 || deviation < -0.2;
            return (
              <tr key={index}>
                <td>{rebalanceItem.code}</td>
                <td>{codeToPrice[rebalanceItem.code]?.name}</td>
                <td>{rebalanceItem.price}</td>
                <td>{closePrice}</td>
                <td>{rebalanceItem.percentage}</td>
                <td>{(proportion*100).toFixed(2)}</td>
                <td style={{
                  textAlign: 'right',
                  ...(
                    rebalanceTriggered
                    ? {backgroundColor: '#7f7'}
                    : rebalanceWarn && { backgroundColor: '#ff7' }),
                }}>{(deviation*100).toFixed(1)}%</td>
              </tr>
            );
          })}
        </tbody>
      </table>  
    </div>
  )
};

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(
  <App />
);

</script>
</body>
</html>
